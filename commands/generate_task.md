---
name: generate_task
description: 根据技术方案生成原子化、TDD 优先的任务列表
parameters:
  - name: module
    description: 规格说明模块目录名称（例如：001-core-functionality）
    required: true
inputs:
  - specs/{module}/spec.md
  - specs/{module}/plan.md
  - constitution.md
  - .claude/templates/task-template.md
outputs:
  - specs/{module}/tasks.md
---

# 命令：generate_task

## 职责边界

将 plan.md 中的技术方案拆解为 AI 可直接执行的原子任务。**只拆 plan.md 里有的内容，不补充未提及的任务。**

**plan.md vs tasks.md 的分工：**

| 文档 | 职责 | 内容 |
|------|------|------|
| `plan.md` | 技术方案 | 详细设计（接口签名、流程图、数据结构、异常处理策略等） |
| `tasks.md` | 执行清单 | 只列「做什么」和「在哪做」，不重复「怎么做」 |

**tasks.md 中禁止出现的内容：**
- 接口方法签名（引用 plan.md 第 X 节）
- 详细实现步骤（引用 plan.md 第 X 节）
- 数据结构定义（引用 plan.md 第 X 节）
- 算法逻辑描述（引用 plan.md 第 X 节）

## 前置检查

执行前确认以下文件存在，缺失则提示用户后停止：
- `specs/{module}/spec.md`
- `specs/{module}/plan.md`
- `constitution.md`
- `.claude/templates/task-template.md`

## 执行流程

### 第一步：理解输入，输出确认摘要

阅读 plan.md 和 constitution.md，提炼以下内容并**输出给用户确认**，等待确认后再继续：

```
我理解的任务范围如下，请确认：
- 需要拆解的模块：[列出]
- 每个模块的测试类型：[单元测试 / 集成测试 / 两者都有]
- 是否包含容器化任务：[是 / 否]
- 是否包含 E2E 测试：[是 / 否]
- 待澄清的问题：[如有则列出，没有则省略]
```

### 第二步：生成 tasks.md

用户确认后，按照 task-template.md 的结构生成任务列表，写入 `specs/{module}/tasks.md`。

生成时遵循以下原则：

**自下而上的顺序**
- 基础设施（依赖、异常定义、配置）→ 核心模块 → 集成层 → 容器化 → E2E
- 不使用 Web 服务的"接口层→业务层→数据层"三层顺序，除非项目本身就是 Web 服务

**每个任务只动一个文件**
- 一个任务 = 一个文件的新建或修改
- 禁止"实现所有功能"、"更新相关文件"这类模糊任务

**TDD 顺序：测试在实现之前**
- 每个模块：单元测试 → 集成测试 → 实现
- 单元测试只测 plan.md 中标注的纯函数

**任务描述简洁化（重点）**
- 每个任务描述不超过 2-3 行
- 禁止重复 plan.md 中已有的细节
- 用「引用 plan.md 第 X 节」代替具体描述
- 模板示例中的详细内容全部改为引用格式

**按需取用模板章节**
- 没有容器化需求就不写容器化章节
- 没有 E2E 就不写 E2E 章节
- 只包含 plan.md 中实际存在的模块

**STUB 的正确用法**
- STUB 用于隔离尚未实现的外部依赖（系统调用、第三方服务）
- 不是用来跳过测试，而是让测试可以在依赖未就绪时先跑起来

### 第三步：自查

写完后对照检查清单自查，发现问题自行修正，无需输出检查过程。

## 检查清单

- [ ] 任务顺序是自下而上（基础设施 → 模块 → 集成 → 部署 → E2E）
- [ ] 每个任务只涉及一个文件
- [ ] 每个实现任务前都有对应的测试任务
- [ ] 单元测试只覆盖 plan.md 中标注的纯函数
- [ ] 不包含 plan.md 未提及的任务
- [ ] 不适用的模板章节已跳过
- [ ] 末尾包含任务统计和执行建议

## 常见错误

- **在 tasks.md 中重复 plan.md 的详细内容**（接口签名、方法用途、数据结构等）
- 用 Web 三层架构（接口层→业务层→数据层）组织 CLI 或脚本类项目的任务
- 把多个文件的修改合并成一个任务
- 测试任务写在实现任务之后
- 单元测试里测了 I/O 操作（应移到集成测试）
- 强行填写不适用的章节（如 CLI 工具写"健康检查接口"任务）
- 跳过第一步确认直接生成

## 后续步骤

tasks.md 确认后，按任务列表从上到下逐一执行，每完成一个将 `[ ]` 改为 `[x]`