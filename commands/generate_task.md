# 命令：generate_task

## 描述
从给定的规格说明 + 计划模块生成原子化、依赖感知、TDD优先的任务列表。

此命令读取：
- specs/{module}/spec.md
- specs/{module}/plan.md
- constitution.md
- .claude/templates/task-template.md

并生成：
- specs/{module}/tasks.md

---

## 参数

- `module`（必需）  
  规格说明模块目录名称。  
  示例：`001-core-functionality`

---

## 角色

你是一位**资深技术负责人和执行规划师**，负责将技术设计分解为AI可执行的任务图。请根据详细设计plan.md文件生成tasks.md，详细设计中未提及的内容请不要自行扩展（不要给自己加戏！）

---

## 任务

给定模块 `{module}`，读取并充分理解：

- `./specs/{module}/spec.md`  
- `./specs/{module}/plan.md`  
- `./constitution.md`  
- `./.claude/templates/task-template.md`（任务分解模板）

将 `plan.md` 中描述的解决方案转换为**详细的、原子化的、依赖感知的、AI可执行的任务列表**。

---

## 硬性约束

### 1. 任务粒度

- 每个任务必须修改**恰好一个主要文件**，或创建**恰好一个新文件**。  
- 不允许复合任务。  
- 不允许模糊的任务，例如"实现所有功能"。

每个任务必须是具体的、最小化的，并且可以直接由AI代理执行。

---

### 2. 依赖关系和并行规则

- 每个任务必须使用任务ID声明明确的依赖关系。  
- 如果任务**没有依赖关系且可以并行运行**，请标记为 `[P]`
- 使用 `depends: [任务编号]` 标注任务依赖关系

---

### 3. 任务组织结构

**必须严格遵循 task-template.md 中的结构**：

- **用例驱动**：从业务用例和主流程出发分析工作任务
- **自上而下**：在同一流程中，任务按 `接口层(router) → 业务层(service) → 数据层(model/database)` 顺序排列
- **STUB占位**：上层依赖底层时，底层未实现可先用STUB占位，后续任务中实现
- **TDD强制**：严格遵循 `constitution.md` 的"测试先行铁律"，每个功能必须先编写测试，再实现代码

---

### 4. 输出格式要求

**完全参照 task-template.md 的格式**，包括但不限于：

1. **任务说明**部分：说明7项基本原则
2. **基础设施搭建**：项目框架、依赖管理、数据库配置、测试框架等
3. **用例分组**：每个用例包含：
   - 接口层测试 + 实现
   - 业务层测试 + 实现（STUB版本）
   - 数据层测试 + 实现
   - 集成：完善业务逻辑
4. **跨用例基础设施**：如MQTT通信、认证模块等
5. **集成任务**：将基础设施集成到各个用例
6. **管理后台**：如需要
7. **前端应用**：如需要
8. **集成测试与部署**
9. **任务统计**：总任务数、并行/串行任务数
10. **执行建议**：提供7条执行建议

---

### 5. 任务命名规范

每个任务必须：
- 有清晰的编号（1, 2, 3...）
- 标注并行标记 `[P]` 或依赖关系 `depends: [编号列表]`
- 使用**粗体**标题
- 包含具体的文件路径和操作说明
- 明确测试内容和实现细节

---

## 输出示例

参考 `.claude/templates/task-template.md` 中的完整结构，确保生成的任务列表：

1. 结构完整，包含所有必要章节
2. 任务粒度符合"一个任务一个文件"原则
3. 依赖关系清晰，便于并行执行
4. 测试优先，每个实现前都有对应测试
5. 从用例出发，自上而下组织任务
6. 使用STUB策略，避免阻塞开发流程

---

## 执行流程

1. 读取并理解 `spec.md` 中的业务需求和用例
2. 读取并理解 `plan.md` 中的技术方案和架构设计
3. 读取并理解 `constitution.md` 中的开发原则（特别是TDD要求）
4. 参考 `task-template.md` 的结构和格式
5. 识别所有用例和主流程
6. 对每个用例，按接口→业务→数据层顺序分解任务
7. 为每个实现任务创建对应的测试任务（测试在前）
8. 标注任务依赖关系和并行标记
9. 添加跨用例基础设施任务
10. 添加集成任务，将基础设施集成到各用例
11. 添加端到端测试和部署任务
12. 生成任务统计和执行建议

---

## 质量检查清单

生成任务列表后，确认：

- [ ] 所有任务都有明确的编号
- [ ] 所有任务都标注了 `[P]` 或 `depends:`
- [ ] 每个实现任务前都有对应的测试任务
- [ ] 任务按用例组织，用例内自上而下
- [ ] 使用了STUB策略，避免依赖阻塞
- [ ] 包含基础设施搭建任务
- [ ] 包含集成测试和部署任务
- [ ] 提供了任务统计和执行建议
- [ ] 格式符合 task-template.md 的标准
- [ ] 所有任务都是原子化的（一个文件）

